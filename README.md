# =============================================================================
# TOBIAS BOT PRO - NOTEBOOK PARA GOOGLE COLAB
# Salve este arquivo como: Tobias_Bot_Pro_Complete.ipynb
# =============================================================================

# INSTRU√á√ïES:
# 1. Abra o Google Colab (colab.research.google.com)
# 2. File > New notebook
# 3. Delete todas as c√©lulas
# 4. Copie e cole cada se√ß√£o abaixo em c√©lulas separadas
# 5. File > Save to GitHub
# 6. Salve como: Tobias_Bot_Pro_Complete.ipynb

# =============================================================================
# C√âLULA 1: MARKDOWN - HEADER
# =============================================================================
"""
Copie este MARKDOWN em uma c√©lula de texto:

# ü§ñ TOBIAS BOT PRO

**Sistema Avan√ßado de Transcri√ß√£o de V√≠deos do YouTube usando IA**

[![GitHub](https://img.shields.io/badge/GitHub-Projeto-blue)](https://github.com/Jamilly_Nicehele/tobias-bot-pro)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](https://github.com/Jamilly_Nichele/tobias-bot-pro/blob/main/LICENSE)

---

## üéØ **O que este notebook faz:**

‚úÖ **Transcreve automaticamente v√≠deos do YouTube**  
‚úÖ **Interface moderna e intuitiva**  
‚úÖ **Suporte a GPU para processamento r√°pido**  
‚úÖ **Sistema robusto com m√∫ltiplas estrat√©gias**  
‚úÖ **Totalmente gratuito e open source**

## üìã **Como usar:**

1. **Execute as c√©lulas em ordem** (Ctrl+F9 para executar todas)
2. **Aguarde a instala√ß√£o** (primeira execu√ß√£o)
3. **Use a interface gr√°fica** que aparecer√°
4. **Cole a URL do YouTube** e clique em "Processar"

---
"""

# =============================================================================
# C√âLULA 2: PYTHON - VERIFICA√á√ÉO DO AMBIENTE
# =============================================================================

# üîç VERIFICA√á√ÉO DO AMBIENTE
print("üîç VERIFICANDO AMBIENTE DO GOOGLE COLAB")
print("=" * 50)

import sys
print(f"üêç Python: {sys.version}")

# Verificar se est√° no Colab
try:
    import google.colab
    print("‚úÖ Google Colab detectado")
    IN_COLAB = True
except ImportError:
    print("‚ö†Ô∏è N√£o est√° no Google Colab")
    IN_COLAB = False

# Verificar GPU
import torch
if torch.cuda.is_available():
    gpu_name = torch.cuda.get_device_name(0)
    gpu_memory = torch.cuda.get_device_properties(0).total_memory / 1024**3
    print(f"üöÄ GPU: {gpu_name}")
    print(f"üíæ VRAM: {gpu_memory:.1f} GB")
    print("‚ö° Status: ACELERA√á√ÉO GPU ATIVADA")
else:
    print("üîß GPU: N√£o detectada")
    print("üí° Dica: Runtime > Change runtime type > GPU")

print("=" * 50)

# =============================================================================
# C√âLULA 3: PYTHON - INSTALA√á√ÉO DE DEPEND√äNCIAS
# =============================================================================

# üì¶ INSTALA√á√ÉO DE DEPEND√äNCIAS
import subprocess
import sys

def install_dependencies():
    """Instala todas as depend√™ncias necess√°rias"""
    print("üöÄ TOBIAS BOT PRO - INSTALA√á√ÉO v2.0")
    print("=" * 50)
    print("‚è±Ô∏è Tempo estimado: 2-3 minutos\n")
    
    # Pacotes essenciais
    packages = [
        'faster-whisper>=0.10.0',
        'yt-dlp>=2023.12.30', 
        'torch>=2.0.0',
        'transformers>=4.35.0',
        'accelerate>=0.24.0',
        'ipywidgets>=8.0.0',
        'tqdm>=4.65.0',
        'pytube>=15.0.0'
    ]
    
    print("üì¶ Instalando pacotes Python...")
    for package in packages:
        try:
            subprocess.check_call([
                sys.executable, "-m", "pip", "install", 
                "-q", "--upgrade", package
            ])
            print(f"   ‚úÖ {package.split('>=')[0]}")
        except Exception as e:
            print(f"   ‚ùå Erro: {package}")
    
    print("\nüéµ Configurando FFmpeg...")
    try:
        subprocess.run(["apt", "update", "-qq"], capture_output=True)
        subprocess.run(["apt", "install", "-y", "ffmpeg"], capture_output=True)
        print("   ‚úÖ FFmpeg instalado")
    except:
        print("   ‚ö†Ô∏è Problema com FFmpeg")
    
    if IN_COLAB:
        print("\nüé® Habilitando widgets...")
        try:
            from google.colab import output
            output.enable_custom_widget_manager()
            print("   ‚úÖ Widgets habilitados")
        except:
            print("   ‚ö†Ô∏è Problema com widgets")
    
    print("\n" + "=" * 50)
    print("‚úÖ INSTALA√á√ÉO CONCLU√çDA!")
    print("=" * 50)

# Executar instala√ß√£o
install_dependencies()

# =============================================================================
# C√âLULA 4: PYTHON - IMPORTA√á√ïES
# =============================================================================

# üìö IMPORTA√á√ïES E CONFIGURA√á√ïES
print("üìö Carregando bibliotecas...")

import os
import re
import torch
import logging
from typing import Optional, List

# Configurar logging
logging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')
logger = logging.getLogger(__name__)

# Importa√ß√µes espec√≠ficas
try:
    from faster_whisper import WhisperModel
    import yt_dlp
    import ipywidgets as widgets
    from IPython.display import display, HTML
    from tqdm.auto import tqdm
    
    print("‚úÖ Bibliotecas carregadas!")
    print(f"üî• Dispositivo: {'GPU' if torch.cuda.is_available() else 'CPU'}")
    
except ImportError as e:
    print(f"‚ùå Erro ao importar: {e}")
    print("üí° Execute a c√©lula de instala√ß√£o novamente")

# =============================================================================
# C√âLULA 5: PYTHON - CLASSE PRINCIPAL
# =============================================================================

# ü§ñ CLASSE PRINCIPAL TOBIAS BOT
class TobiasBotPro:
    """Sistema avan√ßado de transcri√ß√£o de v√≠deos do YouTube"""
    
    def __init__(self, model_size="base"):
        self.model_size = model_size
        self.device = "cuda" if torch.cuda.is_available() else "cpu"
        self.compute_type = "float16" if self.device == "cuda" else "int8"
        self.model = None
        
        print(f"ü§ñ Iniciando Tobias Bot Pro ({model_size})...")
        self._load_model()
    
    def _load_model(self):
        try:
            print("üß† Carregando modelo Whisper...")
            self.model = WhisperModel(
                self.model_size,
                device=self.device,
                compute_type=self.compute_type
            )
            print("‚úÖ Modelo carregado!")
            return True
        except Exception as e:
            print(f"‚ùå Erro: {e}")
            return False
    
    def validate_url(self, url):
        patterns = [
            r'(?:https?://)?(?:www\.)?youtube\.com/watch\?v=([a-zA-Z0-9_-]+)',
            r'(?:https?://)?(?:www\.)?youtu\.be/([a-zA-Z0-9_-]+)',
        ]
        
        for pattern in patterns:
            match = re.search(pattern, url)
            if match:
                video_id = match.group(1)
                return f"https://www.youtube.com/watch?v={video_id}"
        return None
    
    def download_video(self, url):
        clean_url = self.validate_url(url)
        if not clean_url:
            print("‚ùå URL inv√°lida")
            return None
        
        print(f"üîó Processando: {clean_url}")
        
        # Tentar yt-dlp
        audio_file = self._download_with_ydl(clean_url)
        if audio_file:
            return audio_file
        
        # Tentar pytube
        audio_file = self._download_with_pytube(clean_url)
        return audio_file
    
    def _download_with_ydl(self, url):
        configs = [
            {
                'format': 'bestaudio[ext=m4a]/bestaudio',
                'outtmpl': 'audio_%(id)s.%(ext)s',
                'postprocessors': [{
                    'key': 'FFmpegExtractAudio',
                    'preferredcodec': 'wav',
                    'preferredquality': '128',
                }],
            },
            {
                'format': 'worst[ext=mp4]/worst',
                'outtmpl': 'audio_%(id)s.%(ext)s',
                'postprocessors': [{
                    'key': 'FFmpegExtractAudio',
                    'preferredcodec': 'wav',
                    'preferredquality': '96',
                }],
                'http_headers': {
                    'User-Agent': 'Mozilla/5.0 (Android) AppleWebKit/537.36'
                },
                'extractor_args': {
                    'youtube': {'player_client': ['android']}
                },
            }
        ]
        
        for i, config in enumerate(configs, 1):
            try:
                print(f"üì• Tentativa {i}...")
                with yt_dlp.YoutubeDL(config) as ydl:
                    info = ydl.extract_info(url, download=True)
                    return self._find_audio_file(info['id'])
            except Exception as e:
                print(f"‚ùå Tentativa {i} falhou")
                continue
        return None
    
    def _download_with_pytube(self, url):
        try:
            from pytube import YouTube
            print("üì• Tentando pytube...")
            
            yt = YouTube(url)
            audio_stream = yt.streams.filter(only_audio=True).first()
            
            if audio_stream:
                filename = f"audio_{yt.video_id}.mp4"
                audio_stream.download(filename=filename)
                
                wav_file = f"audio_{yt.video_id}.wav"
                if self._convert_to_wav(filename, wav_file):
                    os.remove(filename)
                    return wav_file
                return filename
        except Exception as e:
            print(f"‚ùå Pytube falhou: {e}")
        return None
    
    def _find_audio_file(self, video_id):
        extensions = ['.wav', '.m4a', '.mp3', '.webm', '.mp4']
        for ext in extensions:
            filename = f"audio_{video_id}{ext}"
            if os.path.exists(filename):
                if ext != '.wav':
                    wav_file = f"audio_{video_id}.wav"
                    if self._convert_to_wav(filename, wav_file):
                        os.remove(filename)
                        return wav_file
                return filename
        return None
    
    def _convert_to_wav(self, input_file, output_file):
        try:
            import subprocess
            subprocess.run([
                'ffmpeg', '-i', input_file, '-ar', '16000', 
                '-ac', '1', '-c:a', 'pcm_s16le', output_file, '-y'
            ], capture_output=True, check=True)
            return True
        except:
            return False
    
    def transcribe_audio(self, audio_file):
        if not self.model:
            print("‚ùå Modelo n√£o carregado")
            return None
        
        try:
            print("üéØ Transcrevendo...")
            segments, info = self.model.transcribe(audio_file, language="pt")
            
            print(f"üìä Idioma: {info.language} (confian√ßa: {info.language_probability:.2f})")
            
            full_text = ""
            segments_list = list(segments)
            
            for segment in tqdm(segments_list, desc="Processando"):
                full_text += segment.text + " "
            
            print(f"‚úÖ Conclu√≠do! ({len(segments_list)} segmentos)")
            return full_text.strip()
            
        except Exception as e:
            print(f"‚ùå Erro: {e}")
            return None
    
    def process_video(self, url):
        print("üöÄ PROCESSANDO V√çDEO")
        print("=" * 40)
        
        audio_file = self.download_video(url)
        if not audio_file:
            return None
        
        transcription = self.transcribe_audio(audio_file)
        
        try:
            os.remove(audio_file)
            print(f"üßπ Removido: {audio_file}")
        except:
            pass
        
        print("=" * 40)
        print("‚úÖ CONCLU√çDO!")
        
        return transcription

print("ü§ñ Classe TobiasBotPro criada!")

# =============================================================================
# C√âLULA 6: PYTHON - INTERFACE GR√ÅFICA
# =============================================================================

# üé® INTERFACE GR√ÅFICA MODERNA
def create_interface():
    """Cria interface moderna para o bot"""
    
    # Header HTML
    header_html = """
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                color: white; padding: 25px; border-radius: 15px; 
                text-align: center; margin-bottom: 20px; 
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
        <h1 style="font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
            ü§ñ TOBIAS BOT PRO
        </h1>
        <p style="font-size: 1.1em; margin-bottom: 20px;">
            Sistema Avan√ßado de Transcri√ß√£o com IA
        </p>
        <div style="margin-bottom: 15px;">
            <span style="background: rgba(255,255,255,0.2); padding: 8px 15px; 
                         border-radius: 20px; margin: 5px; font-size: 0.9em;">
                üé• Download Inteligente
            </span>
            <span style="background: rgba(255,255,255,0.2); padding: 8px 15px; 
                         border-radius: 20px; margin: 5px; font-size: 0.9em;">
                üß† IA Whisper
            </span>
            <span style="background: rgba(255,255,255,0.2); padding: 8px 15px; 
                         border-radius: 20px; margin: 5px; font-size: 0.9em;">
                ‚ö° GPU Ready
            </span>
        </div>
        <p style="font-size: 0.9em; opacity: 0.9;">
            üìã <strong>Como usar:</strong> Cole a URL ‚Üí Clique em Processar ‚Üí Aguarde o resultado
        </p>
    </div>
    """
    
    display(HTML(header_html))
    
    # Inicializar bot
    print("üöÄ Inicializando Tobias Bot Pro...")
    bot = TobiasBotPro()
    
    if not bot.model:
        print("‚ùå Erro na inicializa√ß√£o")
        return None
    
    # Widgets
    url_input = widgets.Text(
        placeholder='https://youtube.com/watch?v=... ou https://youtu.be/...',
        description='üì∫ URL:',
        layout=widgets.Layout(width='100%', height='45px'),
        style={'description_width': '80px'}
    )
    
    process_btn = widgets.Button(
        description='üöÄ Processar V√≠deo',
        button_style='success',
        layout=widgets.Layout(width='180px', height='45px')
    )
    
    clear_btn = widgets.Button(
        description='üßπ Limpar',
        button_style='info', 
        layout=widgets.Layout(width='120px', height='45px')
    )
    
    status_output = widgets.HTML(
        value='<p style="color: #666;">‚è≥ Aguardando URL do YouTube...</p>'
    )
    
    result_area = widgets.Textarea(
        placeholder='üìù A transcri√ß√£o aparecer√° aqui...\n\nüí° Funciona melhor com √°udio claro em portugu√™s',
        layout=widgets.Layout(width='100%', height='400px')
    )
    
    # Fun√ß√£o de processamento
    def process_video(btn):
        if not url_input.value.strip():
            status_output.value = '<p style="color: red;">‚ö†Ô∏è Insira uma URL v√°lida</p>'
            return
        
        result_area.value = ""
        status_output.value = '<p style="color: blue;">üîÑ Processando... Aguarde...</p>'
        
        try:
            transcription = bot.process_video(url_input.value.strip())
            
            if transcription:
                result_area.value = transcription
                word_count = len(transcription.split())
                status_output.value = f'<p style="color: green;">‚úÖ Conclu√≠do! ({word_count} palavras)</p>'
            else:
                result_area.value = "‚ùå Erro no processamento.\n\nüí° Tente:\n‚Ä¢ Verificar se o v√≠deo est√° p√∫blico\n‚Ä¢ Usar v√≠deos menores\n‚Ä¢ Tentar outro v√≠deo"
                status_output.value = '<p style="color: red;">‚ùå Falha no processamento</p>'
            
        except Exception as e:
            result_area.value = f"‚ùå Erro: {str(e)}\n\nüí° Tente executar todas as c√©lulas novamente"
            status_output.value = '<p style="color: red;">‚ùå Erro inesperado</p>'
    
    def clear_all(btn):
        url_input.value = ""
        result_area.value = ""
        status_output.value = '<p style="color: #666;">‚è≥ Aguardando nova URL...</p>'
    
    # Conectar eventos
    process_btn.on_click(process_video)
    clear_btn.on_click(clear_all)
    
    # Layout
    interface = widgets.VBox([
        widgets.HBox([url_input]),
        widgets.HBox([process_btn, clear_btn]),
        status_output,
        widgets.HTML('<hr><h3>üìù Resultado da Transcri√ß√£o</h3>'),
        result_area
    ])
    
    display(interface)
    
    # Info final
    info_html = """
    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; 
                margin-top: 20px; border-left: 4px solid #007bff;">
        <h4 style="color: #007bff; margin-top: 0;">üí° Dicas de Uso</h4>
        <ul>
            <li><strong>URLs:</strong> youtube.com/watch?v=... ou youtu.be/...</li>
            <li><strong>Dura√ß√£o:</strong> V√≠deos at√© 1 hora funcionam melhor</li>
            <li><strong>√Åudio:</strong> Qualidade clara produz melhor resultado</li>
        </ul>
    </div>
    
    <div style="text-align: center; margin-top: 20px; padding: 15px; 
                background: #e7f3ff; border-radius: 8px;">
        <strong>üåü Gostou?</strong> 
        <a href="https://github.com/SEU_USERNAME/tobias-bot-pro" target="_blank">
            ‚≠ê Deixe uma estrela no GitHub!
        </a>
    </div>
    """
    
    display(HTML(info_html))
    return bot

print("üé® Interface criada!")

# =============================================================================
# C√âLULA 7: PYTHON - FUN√á√ïES UTILIT√ÅRIAS
# =============================================================================

# üîß FUN√á√ïES UTILIT√ÅRIAS
def test_url(url):
    """Testa URL rapidamente"""
    print(f"üß™ Testando: {url}")
    
    bot = TobiasBotPro()
    clean_url = bot.validate_url(url)
    
    if clean_url:
        print(f"‚úÖ URL v√°lida: {clean_url}")
        try:
            with yt_dlp.YoutubeDL({'quiet': True}) as ydl:
                info = ydl.extract_info(clean_url, download=False)
                print(f"üé¨ T√≠tulo: {info.get('title', 'N/A')}")
                print(f"‚è±Ô∏è Dura√ß√£o: {info.get('duration', 'N/A')}s")
                return True
        except:
            print("‚ùå Erro ao acessar")
    else:
        print("‚ùå URL inv√°lida")
    
    return False

def fix_youtube_403():
    """Corrige erros 403"""
    print("üîß Atualizando yt-dlp...")
    try:
        subprocess.check_call([sys.executable, "-m", "pip", "install", "--upgrade", "yt-dlp"])
        print("‚úÖ Atualizado com sucesso")
    except:
        print("‚ùå Erro na atualiza√ß√£o")

print("üîß Utilit√°rios carregados!")

# =============================================================================
# C√âLULA 8: PYTHON - INICIALIZA√á√ÉO PRINCIPAL
# =============================================================================

# üöÄ INICIALIZA√á√ÉO PRINCIPAL
print("üéâ TOBIAS BOT PRO - INICIALIZA√á√ÉO FINAL")
print("=" * 50)

# Info do sistema
print(f"üêç Python: {sys.version.split()[0]}")
print(f"üî• PyTorch: {torch.__version__}")
print(f"üéØ Device: {'GPU' if torch.cuda.is_available() else 'CPU'}")

if torch.cuda.is_available():
    print(f"üöÄ GPU: {torch.cuda.get_device_name(0)}")

print("\nüöÄ Carregando interface...")
bot = create_interface()

if bot:
    print("\n‚úÖ TUDO PRONTO!")
    print("üëÜ Use a interface acima")
    print("\nüí° COMANDOS EXTRAS:")
    print("‚Ä¢ test_url('URL')     - Testa URL")
    print("‚Ä¢ fix_youtube_403()   - Corrige erro 403")
    
    print(f"\nüìä STATUS:")
    print(f"   ü§ñ Modelo: {bot.model_size}")
    print(f"   üíª Device: {bot.device}")
    print(f"   üß† Status: {'‚úÖ Pronto' if bot.model else '‚ùå Erro'}")
else:
    print("‚ùå Erro na inicializa√ß√£o")

print("=" * 50)

# =============================================================================
# C√âLULA 9: MARKDOWN - FOOTER
# =============================================================================
"""
Copie este MARKDOWN em uma c√©lula de texto:

---

# üéâ **Parab√©ns! Tobias Bot Pro funcionando!**

## üöÄ **Pr√≥ximos passos:**

1. **Use a interface acima** para transcrever v√≠deos
2. **Compartilhe este notebook** com amigos
3. **Contribua no GitHub** com melhorias
4. **Deixe uma ‚≠ê** se gostou do projeto

## üí° **Casos de uso:**

- üìö **Estudantes**: Transcrever aulas gravadas  
- üéôÔ∏è **Podcasters**: Converter epis√≥dios para texto
- üì∞ **Jornalistas**: Transcrever entrevistas
- üé¨ **Criadores**: Gerar legendas automaticamente

## üÜò **Precisa de ajuda?**

- üêõ **Bug?** [Abra issue no GitHub](https://github.com/Jamilly_Nichele/tobias-bot-pro/issues)
- üí° **Sugest√£o?** [Envie pull request](https://github.com/Jamilly_Nichele/tobias-bot-pro/pulls)  
- üí¨ **D√∫vidas?** [Entre em contato](https://linkedin.com/in/seu_perfil)

---

<div align="center">

**ü§ñ Tobias Bot Pro** | **v2.0.0** | **MIT License**

Desenvolvido com ‚ù§Ô∏è para a comunidade

[![GitHub](https://img.shields.io/badge/GitHub-Projeto-blue)](https://github.com/Jamilly_Nichele/tobias-bot-pro)
[![LinkedIn](https://img.shields.io/badge/LinkedIn-Perfil-blue)](https://linkedin.com/in/seu_perfil)

</div>
"""
